require 'net/http'
require_relative 'config'

publish do |message|
  invoke :clean
  invoke :docker
  invoke :bundle
  invoke :git, message
  invoke :purge
end

backend do
  shh 'ruby src/rb/server.rb'
end

clean do
  sh? 'rm -rf dist index.html'
  sh? 'rm -rf .cache'
  sh? 'rm -rf .byebug_history'
end

git do |message|
  sh 'git add -A'
  sh "git commit -m '#{message}'"
  sh 'git push'
end

tag = 'gcr.io/catan-274322/catan'
docker do
  invoke :docker_build
  invoke :docker_push
end

docker_build do
  sh "docker build . -t #{tag}"
end

docker_push do
  sh "docker push #{tag}"
end

purge do
  uri = URI("https://api.cloudflare.com/client/v4/zones/#{CONFIG.cloudflare_zone_identifier}/purge_cache")
  res = Net::HTTP.post(uri, { purge_everything: true }.to_json,
    'Authorization' => "Bearer #{CONFIG.cloudflare_api_token}",
    'Content-Type' => 'application/json',
  )

  if res.code == '200'
    puts 'purged cache'
  else
    puts "failed to purge cache: #{res.body}"
  end
end
